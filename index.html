<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Facture & Calculateur d'heures</title>
  <!-- âœ… Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(180deg, #E0FFFF 0%, #F0F8FF 100%);
      font-family: "Inter", system-ui, sans-serif;
      color: #0f1724;
      padding-bottom: 4rem;
    }
    h1, h2, h3 {
      color: #0f1724;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .btn-primary {
      background-color: #00bcd4;
      border: none;
    }
    .btn-primary:hover {
      background-color: #0097a7;
    }
    .form-control:focus {
      border-color: #00bcd4;
      box-shadow: 0 0 0 0.2rem rgba(0,188,212,0.25);
    }
    .modal-content {
      border-radius: 16px;
    }
    .invoice-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
    }
    @media print {
      body * { visibility: hidden; }
      #invoicePrint, #invoicePrint * { visibility: visible; }
      #invoicePrint { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <h1 class="text-center mb-4 fw-bold">ðŸ•“ Calculateur d'heures & GÃ©nÃ©rateur de Facture</h1>

    <div class="card p-3 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Tarif horaire (â‚¬)</label>
          <input id="rate" type="number" step="0.01" class="form-control" value="14.5">
        </div>
        <div class="col-md-8 text-md-end text-center">
          <button id="addRow" class="btn btn-outline-info me-2">âž• Ajouter un jour</button>
          <button id="calc" class="btn btn-primary me-2">ðŸ§® Calculer</button>
          <button id="invoiceInfo" class="btn btn-success me-2">ðŸ§¾ Infos Facture</button>
          <button id="generate" class="btn btn-dark">ðŸ“„ GÃ©nÃ©rer Facture</button>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-striped text-center align-middle">
          <thead class="table-info">
            <tr>
              <th>EntrÃ©e</th>
              <th>DÃ©but pause</th>
              <th>Fin pause</th>
              <th>Sortie</th>
              <th>Heures payÃ©es</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="text-end mt-3">
        <h5>Total : <span id="totalTime" class="fw-bold">0 h 00 min</span></h5>
        <h5>Montant : <span id="totalAmount" class="fw-bold">0,00 â‚¬</span></h5>
      </div>
    </div>
  </div>

  <!-- ðŸ’¡ MODAL FORMULAIRE FACTURE -->
  <div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Informations de la facture</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nom / Entreprise</label>
              <input type="text" class="form-control" id="inv_name">
            </div>
            <div class="col-md-6">
              <label class="form-label">SIRET</label>
              <input type="text" class="form-control" id="inv_siret">
            </div>
            <div class="col-12">
              <label class="form-label">Adresse</label>
              <input type="text" class="form-control" id="inv_addr">
            </div>
            <div class="col-md-6">
              <label class="form-label">TÃ©lÃ©phone</label>
              <input type="text" class="form-control" id="inv_tel">
            </div>
            <div class="col-md-6">
              <label class="form-label">E-mail</label>
              <input type="text" class="form-control" id="inv_email">
            </div>
            <hr>
            <div class="col-md-6">
              <label class="form-label">Client</label>
              <input type="text" class="form-control" id="cli_name">
            </div>
            <div class="col-md-6">
              <label class="form-label">SIRET client</label>
              <input type="text" class="form-control" id="cli_siret">
            </div>
            <div class="col-12">
              <label class="form-label">Adresse client</label>
              <input type="text" class="form-control" id="cli_addr">
            </div>
            <div class="col-md-6">
              <label class="form-label">Facture nÂ° / Mois</label>
              <input type="text" class="form-control" id="obj">
            </div>
            <div class="col-md-6">
              <label class="form-label">Date de facture</label>
              <input type="date" class="form-control" id="inv_date">
            </div>
            <div class="col-md-6">
              <label class="form-label">Nom / Code prestation</label>
              <input type="text" class="form-control" id="item_code">
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="item_desc" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          <button id="saveInvoice" class="btn btn-primary">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ’¾ Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const rowsEl = document.getElementById('rows');
    const totalTimeEl = document.getElementById('totalTime');
    const totalAmountEl = document.getElementById('totalAmount');
    const rateEl = document.getElementById('rate');

    function createRow() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="time" class="form-control in"></td>
        <td><input type="time" class="form-control ps"></td>
        <td><input type="time" class="form-control pe"></td>
        <td><input type="time" class="form-control out"></td>
        <td class="worked fw-semibold text-primary">â€”</td>
      `;
      rowsEl.appendChild(tr);
    }

    function timeToMinutes(t) {
      if (!t) return null;
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    function formatHM(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h} h ${m.toString().padStart(2, '0')} min`;
    }

    function calculateAll() {
      let total = 0;
      [...rowsEl.children].forEach(tr => {
        const start = timeToMinutes(tr.querySelector('.in').value);
        const ps = timeToMinutes(tr.querySelector('.ps').value);
        const pe = timeToMinutes(tr.querySelector('.pe').value);
        const end = timeToMinutes(tr.querySelector('.out').value);
        const cell = tr.querySelector('.worked');
        if (start == null || end == null) return;
        let pause = (ps != null && pe != null) ? Math.max(0, pe - ps) : 0;
        let worked = end - start - pause;
        if (worked < 0) worked += 24 * 60;
        total += worked;
        cell.textContent = formatHM(worked);
      });
      const rate = parseFloat(rateEl.value) || 0;
      totalTimeEl.textContent = formatHM(total);
      totalAmountEl.textContent = (total / 60 * rate).toFixed(2) + ' â‚¬';
      return { total, rate };
    }

    document.getElementById('addRow').onclick = createRow;
    document.getElementById('calc').onclick = calculateAll;

    // Modal Bootstrap
    const invoiceModal = new bootstrap.Modal('#invoiceModal');
    document.getElementById('invoiceInfo').onclick = () => invoiceModal.show();

    document.getElementById('saveInvoice').onclick = () => {
      invoiceModal.hide();
      alert("âœ… Informations enregistrÃ©es !");
    };

    // GÃ©nÃ©ration de la facture imprimable
    document.getElementById('generate').onclick = () => {
      const { total, rate } = calculateAll();
      const qty = (total / 60).toFixed(2);
      const totalHT = (qty * rate).toFixed(2);
      const date = document.getElementById('inv_date').value || new Date().toLocaleDateString('fr-FR');
      const html = `
      <div id="invoicePrint" class="invoice-container container">
        <h3 class="text-center fw-bold mb-4">FACTURE</h3>
        <div class="row">
          <div class="col-md-6">
            <strong>${inv_name.value}</strong><br>
            ${inv_addr.value}<br>
            Siret : ${inv_siret.value}<br>
            Tel : ${inv_tel.value}<br>
            Email : ${inv_email.value}
          </div>
          <div class="col-md-6 text-end">
            <strong>${cli_name.value}</strong><br>
            ${cli_addr.value}<br>
            Siret : ${cli_siret.value}
          </div>
        </div>
        <hr>
        <p><strong>Objet :</strong> ${obj.value} | <strong>Date :</strong> ${date}</p>
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>Nom / Code</th>
              <th>Description</th>
              <th>Qte (h)</th>
              <th>PU HT</th>
              <th>TVA</th>
              <th>Total HT</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${item_code.value || "Heures"}</td>
              <td>${item_desc.value || "Prestation de service"}</td>
              <td>${qty}</td>
              <td>${rate.toFixed(2)} â‚¬</td>
              <td>0%</td>
              <td>${totalHT} â‚¬</td>
            </tr>
          </tbody>
        </table>
        <div class="text-end">
          <p><strong>Total net HT :</strong> ${totalHT} â‚¬</p>
          <p><strong>Montant TVA :</strong> 0.00 â‚¬</p>
          <h5><strong>Total Ã  rÃ©gler :</strong> ${totalHT} â‚¬</h5>
        </div>
        <p class="mt-4 text-muted"><em>NB : TVA non applicable â€“ article 293 B du CGI</em></p>
      </div>`;
      const w = window.open('', '_blank');
      w.document.write('<html><head><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"></head><body>');
      w.document.write(html);
      w.document.write('</body></html>');
      w.document.close();
      setTimeout(() => { w.print(); }, 500);
    };

    // Initial row
    createRow();
  </script>
</body>
</html>
